#!/usr/bin/env node

// load node modules
var path = require("path"),
    fs   = require("fs"),
    cp   = require("child_process");

var cwd = path.resolve(__dirname, "..");

// check/copy json config files
var confPath   = path.join(cwd,      "conf");
var samplePath = path.join(confPath, "samples");

fs.readdirSync(samplePath).forEach(function(file) {
  // copy all json files if they do not exist yet
  if (!/\.json$/.test(file)) {
    return;
  }

  var src = path.join(samplePath, file);
  var dst = path.join(confPath,   file);

  if (!fs.existsSync(dst)) {
    fs.writeFileSync(dst, fs.readFileSync(src));
  }
});

// create a symlink node_modules/homectrl/index.js -> lib/public.js
// to be able to require "homectrl" in plugins
var hcModDir = path.resolve(cwd, "node_modules/homectrl");
if (!fs.existsSync(hcModDir)) {
  fs.mkdirSync(hcModDir);

  var src = path.resolve(cwd, "lib/public.js");
  var dst = path.join(hcModDir, "index.js");
  fs.symlinkSync(src, dst);
}

// fork the server
var opts = {
  cwd: cwd,
  env: process.env
};
cp.fork("lib/server.js", process.argv.splice(2), opts);
